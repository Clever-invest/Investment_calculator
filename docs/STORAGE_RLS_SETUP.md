# Настройка RLS политик для Storage bucket 'property-images'

## Проблема

При открытии объекта с изображениями возникает ошибка "Object not found" при попытке получить signed URL для изображений, загруженных другим пользователем. Это происходит из-за отсутствия RLS политик, которые разрешают чтение изображений для объектов в общем доступе.

## Решение

Нужно создать RLS политики для bucket `property-images`, которые разрешают:
1. Читать свои собственные изображения
2. Читать изображения объектов, которые доступны всем (не архивированы)
3. Загружать/обновлять/удалять только свои изображения

## Инструкция по настройке

### Вариант 1: Через Supabase Dashboard (рекомендуется)

1. Откройте Supabase Dashboard → **Storage** → **Policies**
2. Выберите bucket `property-images`
3. Нажмите **"New Policy"**
4. Для каждой политики:
   - **Policy name**: используйте имена из SQL файла
   - **Allowed operation**: SELECT, INSERT, UPDATE, DELETE (соответственно)
   - **Policy definition**: скопируйте USING/WITH CHECK условия из SQL файла

### Вариант 2: Через SQL Editor

1. Откройте Supabase Dashboard → **SQL Editor**
2. Скопируйте содержимое файла `docs/storage_rls_policies.sql`
3. Выполните SQL запрос

### Вариант 3: Через Supabase CLI

```bash
# Если у вас настроен Supabase CLI
supabase db execute -f docs/storage_rls_policies.sql
```

## Проверка политик

После создания политик проверьте:

1. **Проверка чтения своих изображений:**
   - Загрузите изображение в свой объект
   - Откройте объект - изображение должно отображаться

2. **Проверка чтения чужих изображений:**
   - Откройте объект другого пользователя (который не архивирован)
   - Изображения должны отображаться

3. **Проверка ограничений:**
   - Попробуйте удалить изображение другого пользователя - должно быть запрещено
   - Попробуйте загрузить изображение в папку другого пользователя - должно быть запрещено

## Альтернативное решение (если политики не работают)

Если RLS политики не решают проблему, можно сделать bucket публичным для чтения:

1. Supabase Dashboard → **Storage** → **Buckets**
2. Выберите `property-images`
3. Включите **"Public bucket"**
4. Обновите код для использования `getImageUrl` вместо `getSignedImageUrl` для публичных изображений

**Внимание:** Публичный bucket означает, что все изображения будут доступны по публичным URL без авторизации. Это менее безопасно, но проще в настройке.

## Troubleshooting

### Ошибка "Object not found" все еще возникает

1. Проверьте, что политики созданы и активны
2. Проверьте, что bucket существует и называется `property-images`
3. Проверьте формат пути: `userId/propertyId/image_X.ext`
4. Убедитесь, что объект в таблице `properties` не архивирован (`is_archived = false`)

### Ошибка при создании политики

1. Убедитесь, что вы используете правильный синтаксис для вашей версии Supabase
2. Проверьте, что функция `storage.foldername()` доступна
3. Если функция недоступна, используйте альтернативный подход с `split_part()`:

```sql
-- Альтернативный вариант для получения userId из пути
auth.uid()::text = split_part(name, '/', 1)
```

### Изображения не отображаются после настройки

1. Очистите кеш браузера
2. Проверьте консоль браузера на наличие ошибок
3. Убедитесь, что пути в БД корректны
4. Проверьте, что signed URLs генерируются правильно

